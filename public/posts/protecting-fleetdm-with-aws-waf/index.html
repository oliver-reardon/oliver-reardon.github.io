<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Protecting FleetDM with AWS WAF :: Oliver Reardon</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="How to secure the FleetDM web console using AWS WAF, IP restrictions, and Terraform automation." />
<meta name="keywords" content="FleetDM, AWS WAF, web security, IP restriction, terraform, cloud, osquery" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="//localhost:1313/posts/protecting-fleetdm-with-aws-waf/" />





  
  <link rel="stylesheet" href="//localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/code.min.4f0ccc8439f99bf7f7970298556b94011aabc1fcae743b6842fc3361a2da9ea3.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/main.min.15870410d15d02abd22fb5ef00996f65a00d04b3a7435e9f83831c7c2298de88.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="//localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Protecting FleetDM with AWS WAF">
<meta property="og:description" content="How to secure the FleetDM web console using AWS WAF, IP restrictions, and Terraform automation." />
<meta property="og:url" content="//localhost:1313/posts/protecting-fleetdm-with-aws-waf/" />
<meta property="og:site_name" content="Oliver Reardon" />

  
  
  <meta property="og:image" content="//localhost:1313/">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2024-08-25 13:16:10 -0400 EDT" />












</head>
<body>


<div class="container full">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Oliver Reardon
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/">Talent Profile</a></li>
        
      
        
          <li><a href="/posts">Posts</a></li>
        
      
        
          <li><a href="https://linkedin.com/in/oliver-reardon">LinkedIn</a></li>
        
      
        
          <li><a href="https://github.com/oliver-reardon">GitHub</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/" >Talent Profile</a></li>
        
      
        
          <li><a href="/posts" >Posts</a></li>
        
      
      
        <li>
          <ul class="menu">
            <li class="menu__trigger">Show more&nbsp;▾</li>
            <li>
              <ul class="menu__dropdown">
                
                  
                    <li><a href="https://linkedin.com/in/oliver-reardon" >LinkedIn</a></li>
                  
                
                  
                    <li><a href="https://github.com/oliver-reardon" >GitHub</a></li>
                  
                
              </ul>
            </li>
          </ul>
        </li>
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="//localhost:1313/posts/protecting-fleetdm-with-aws-waf/">Protecting FleetDM with AWS WAF</a>
  </h1>
  <div class="post-meta"><time class="post-date">2024-08-25</time><span class="post-author">Oliver Reardon</span><span class="post-reading-time">4 min read (695 words)</span></div>

  
    <span class="post-tags">
      
      #<a href="//localhost:1313/tags/fleetdm/">FleetDM</a>&nbsp;
      
      #<a href="//localhost:1313/tags/aws-waf/">AWS WAF</a>&nbsp;
      
      #<a href="//localhost:1313/tags/security/">security</a>&nbsp;
      
      #<a href="//localhost:1313/tags/terraform/">terraform</a>&nbsp;
      
      #<a href="//localhost:1313/tags/cloud/">cloud</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <h1 id="protecting-fleetdm-with-aws-waf">Protecting FleetDM with AWS WAF<a href="#protecting-fleetdm-with-aws-waf" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>The <a href="https://fleetdm.com/docs/get-started/why-fleet?gad_source=1">FleetDM</a> web console presents a valuable interface for managing endpoints — and like any administrative UI, it benefits from being accessible only to trusted networks. This configuration uses AWS WAF to restrict direct access based on source IP address, ensuring that only traffic from defined locations is allowed to reach the console.</p>
<p>The setup blocks all traffic by default and permits access only from trusted IP ranges, such as internal corporate networks and secure gateways used by managed browsers. While broader access policies are handled through a separate zero trust architecture, the WAF provides a clear network-layer boundary that limits exposure at the edge.</p>
<p>This post outlines the design, configuration, and purpose of this WAF setup.</p>
<p>For a complete example and Terraform code, see my repository: <a href="https://github.com/oliver-reardon/fleet-aws-waf">fleet-aws-waf on GitHub</a></p>
<h2 id="why-use-aws-waf">Why Use AWS WAF?<a href="#why-use-aws-waf" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Even with authentication and device-based policies in place, it&rsquo;s often desirable to ensure that an application like FleetDM is not reachable at all from the open internet. AWS WAF serves this purpose by inspecting incoming requests at the edge and filtering based on predefined rules — before they reach the application load balancer.</p>
<p>In this implementation, WAF is used to:</p>
<ol>
<li>Block all requests by default
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="k">default_action</span> {
</span></span><span class="line"><span class="cl"> <span class="k">block</span> {}
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div></li>
<li>Allow traffic from trusted CIDRs or ranges
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="k">statement</span> {
</span></span><span class="line"><span class="cl">   <span class="err">//</span> <span class="k">allow</span> <span class="k">traffic</span> <span class="k">from</span> <span class="k">internal</span> <span class="k">cidrs</span>
</span></span><span class="line"><span class="cl">   <span class="k">ip_set_reference_statement</span> {
</span></span><span class="line"><span class="cl"><span class="n">     arn</span> <span class="o">=</span> <span class="k">aws_wafv2_ip_set</span><span class="p">.</span><span class="k">main</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl"><span class="p">...</span> 
</span></span></code></pre></div></li>
<li>Permit specific public API endpoints required for osquery agents
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="k">statement</span> {
</span></span><span class="line"><span class="cl">   <span class="err">//</span> <span class="k">allow</span> <span class="k">public</span> <span class="k">traffic</span> <span class="k">to</span> <span class="k">only</span> <span class="k">these</span> <span class="k">endpoints</span>
</span></span><span class="line"><span class="cl">   <span class="err">//</span> <span class="k">https</span><span class="err">://</span><span class="k">fleetdm</span><span class="p">.</span><span class="k">com</span><span class="err">/</span><span class="k">guides</span><span class="err">/</span><span class="k">what</span><span class="err">-</span><span class="k">api</span><span class="err">-</span><span class="k">endpoints</span><span class="err">-</span><span class="k">to</span><span class="err">-</span><span class="k">expose</span><span class="err">-</span><span class="k">to</span><span class="err">-</span><span class="k">the</span><span class="err">-</span><span class="k">public</span><span class="err">-</span><span class="k">internet</span>
</span></span><span class="line"><span class="cl">   <span class="k">or_statement</span> {
</span></span><span class="line"><span class="cl">     <span class="k">statement</span> {
</span></span><span class="line"><span class="cl">       <span class="k">byte_match_statement</span> {
</span></span><span class="line"><span class="cl"><span class="n">         positional_constraint</span> <span class="o">=</span> <span class="s2">&#34;CONTAINS&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">         search_string</span>         <span class="o">=</span> <span class="s2">&#34;/api/v1/osquery&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="k">field_to_match</span> {
</span></span><span class="line"><span class="cl">           <span class="k">uri_path</span> {}
</span></span><span class="line"><span class="cl">         }
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div></li>
<li>Log all request activity to CloudWatch for visibility
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_wafv2_web_acl_logging_configuration&#34; &#34;example&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">   log_destination_configs</span> <span class="o">=</span> <span class="p">[</span><span class="k">aws_cloudwatch_log_group</span><span class="p">.</span><span class="k">example</span><span class="p">.</span><span class="k">arn</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">   resource_arn</span>            <span class="o">=</span> <span class="k">aws_wafv2_web_acl</span><span class="p">.</span><span class="k">main</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div></li>
</ol>
<h2 id="what-the-waf-configuration-does">What the WAF Configuration Does<a href="#what-the-waf-configuration-does" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>The <a href="https://github.com/oliver-reardon/fleet-aws-waf">Terraform configuration</a> handles several key components:</p>
<ol>
<li>
<p><strong>WAF Web ACL</strong></p>
<ul>
<li>The core policy that defines which requests are allowed or blocked.</li>
<li>Default behavior is to block all requests unless explicitly allowed.</li>
</ul>
</li>
<li>
<p><strong>Trusted IP Ranges</strong></p>
<ul>
<li>Defined via an <code>aws_wafv2_ip_set</code>, which includes internal IP blocks and secure gateway egress addresses.</li>
<li>Used in a rule that allows access to the console from these sources.</li>
</ul>
</li>
<li>
<p><strong>API Endpoint Exceptions</strong></p>
<ul>
<li>Osquery agents require certain endpoints to be accessible from the public internet.</li>
<li>These include paths like <code>/api/osquery</code> and <code>/api/fleet/orbit</code>, which are explicitly permitted.</li>
</ul>
</li>
<li>
<p><strong>CloudWatch Logging</strong></p>
<ul>
<li>Logs are sent to a designated CloudWatch Log Group for auditing and monitoring.</li>
<li>An IAM resource policy grants the WAF service permission to write logs.</li>
</ul>
</li>
<li>
<p><strong>Integration with ALB</strong></p>
<ul>
<li>The Web ACL is attached to the Application Load Balancer that fronts FleetDM.</li>
<li>This ensures that all traffic passes through WAF filtering before reaching the app.</li>
</ul>
</li>
</ol>
<h2 id="observability-and-logging">Observability and Logging<a href="#observability-and-logging" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Logs are written to CloudWatch for both allowed and blocked requests. This enables insight into:</p>
<ul>
<li>Unexpected sources attempting to access the console</li>
<li>Frequency and volume of agent check-ins</li>
<li>Behavior of internal users routing through trusted gateways</li>
</ul>
<p>Each WAF rule has metrics enabled, making it possible to create dashboards or trigger alarms based on activity volume or anomalies.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="k">visibility_config</span> {
</span></span><span class="line"><span class="cl"><span class="n">      cloudwatch_metrics_enabled</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="n">      metric_name</span>                <span class="o">=</span> <span class="s2">&#34;${var.waf_config.name}-allow-api-endpoints-metrics&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">      sampled_requests_enabled</span>   <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div><h2 id="why-allow-api-endpoints">Why Allow API Endpoints?<a href="#why-allow-api-endpoints" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>While the console should remain restricted, the backend must remain reachable by osquery agents that live on the public internet. To support this, a small number of API paths are allowed using byte match statements in WAF. These endpoints are:</p>
<ul>
<li><code>/api/osquery</code></li>
<li><code>/api/v1/osquery</code></li>
<li><code>/api/fleet/orbit</code></li>
<li><code>/api/fleet/device/ping</code></li>
</ul>
<p>These are safe to expose and are required for devices to check in and send results as defined <a href="https://fleetdm.com/guides/what-api-endpoints-to-expose-to-the-public-internet#:~:text=and%20scripts%20functionality%2C-,/api/fleet/orbit/*,-and/api/fleet">here</a>. There are additional endpoints that can be exposed depending on if MDM is being used or the <code>fleetctl</code> CLI needs access from outside the network.</p>
<h2 id="terraform-driven-setup">Terraform-Driven Setup<a href="#terraform-driven-setup" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>All resources — WAF rules, IP sets, log configuration, and associations — are managed via Terraform. This allows for reproducibility across environments, auditability through version control, and easier updates as network requirements evolve.</p>
<h2 id="summary">Summary<a href="#summary" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>This WAF configuration acts as a perimeter guard, limiting access to the FleetDM web console to trusted networks while ensuring essential functionality for osquery agents is preserved. It complements more advanced access control systems by reducing the attack surface and eliminating unnecessary exposure — all while being fully managed through code.</p>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
