<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>OSQuery Results to Loki with Kinesis Data Stream :: Oliver Reardon</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="A practical guide on forwarding macOS application usage data from osquery to Grafana Loki using AWS Kinesis and Lambda for enrichment." />
<meta name="keywords" content="osquery, grafana, loki, kinesis data stream, fleetdm, lambda transformation, log aggregation, macOS telemetry" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="//localhost:1313/posts/osquery-results-to-loki-with-kinesis-data-stream/" />





  
  <link rel="stylesheet" href="//localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/code.min.4f0ccc8439f99bf7f7970298556b94011aabc1fcae743b6842fc3361a2da9ea3.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/main.min.15870410d15d02abd22fb5ef00996f65a00d04b3a7435e9f83831c7c2298de88.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="//localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="OSQuery Results to Loki with Kinesis Data Stream">
<meta property="og:description" content="A practical guide on forwarding macOS application usage data from osquery to Grafana Loki using AWS Kinesis and Lambda for enrichment." />
<meta property="og:url" content="//localhost:1313/posts/osquery-results-to-loki-with-kinesis-data-stream/" />
<meta property="og:site_name" content="Oliver Reardon" />

  
  
  <meta property="og:image" content="//localhost:1313/">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2023-10-19 11:35:25 -0400 EDT" />












</head>
<body>


<div class="container full">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Oliver Reardon
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/">Talent Profile</a></li>
        
      
        
          <li><a href="/posts">Posts</a></li>
        
      
        
          <li><a href="https://linkedin.com/in/oliver-reardon">LinkedIn</a></li>
        
      
        
          <li><a href="https://github.com/oliver-reardon">GitHub</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/" >Talent Profile</a></li>
        
      
        
          <li><a href="/posts" >Posts</a></li>
        
      
      
        <li>
          <ul class="menu">
            <li class="menu__trigger">Show more&nbsp;▾</li>
            <li>
              <ul class="menu__dropdown">
                
                  
                    <li><a href="https://linkedin.com/in/oliver-reardon" >LinkedIn</a></li>
                  
                
                  
                    <li><a href="https://github.com/oliver-reardon" >GitHub</a></li>
                  
                
              </ul>
            </li>
          </ul>
        </li>
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="//localhost:1313/posts/osquery-results-to-loki-with-kinesis-data-stream/">OSQuery Results to Loki with Kinesis Data Stream</a>
  </h1>
  <div class="post-meta"><time class="post-date">2023-10-19</time><span class="post-author">Oliver Reardon</span><span class="post-reading-time">4 min read (656 words)</span></div>

  
    <span class="post-tags">
      
      #<a href="//localhost:1313/tags/osquery/">osquery</a>&nbsp;
      
      #<a href="//localhost:1313/tags/loki/">loki</a>&nbsp;
      
      #<a href="//localhost:1313/tags/kinesis/">kinesis</a>&nbsp;
      
      #<a href="//localhost:1313/tags/fleetdm/">fleetdm</a>&nbsp;
      
      #<a href="//localhost:1313/tags/lambda/">lambda</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <p>Forwarding <a href="https://www.osquery.io/">osquery</a> results to a log aggregator or SIEM requires enriching the JSON data payload to match the destination’s expected structure. <a href="https://aws.amazon.com/kinesis/data-streams/">AWS Kinesis Data Streams</a> ingests data in real time, applies transformations using Lambda, and then delivers the enriched JSON payload to the downstream destination — in this case, <a href="https://grafana.com/oss/loki/">Grafana Loki</a>.</p>
<p>The osquery manager (<a href="https://fleetdm.com/docs/get-started/why-fleet?gad_source=1">FleetDM</a>) runs as a container in AWS with the results plugin enabled by setting the environment variable <code>FLEET_OSQUERY_RESULT_LOG_PLUGIN</code> to <code>kinesis</code>. Additionally, defining <code>FLEET_KINESIS_RESULT_STREAM</code> with the name of the Kinesis Data Stream, which, in the Terraform setup, is referenced as <code>aws_kinesis_stream.data_stream.name</code>.</p>
<p>This macOS specific query focuses on 3 applications and logs the respective applications characteristics as query results:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">bundle_executable</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">bundle_identifier</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">bundle_name</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">bundle_short_version</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">bundle_version</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">display_name</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">name</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">path</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nf">strftime</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">last_opened_time</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;unixepoch&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">last_opened_time</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">apps</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">last_opened_time</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;-1.0&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="n">bundle_name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Chrome&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Slack&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;zoom.us&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>Once the above query automation runs, the data is forwarded to the downstream log destination (AWS Kinesis Data Stream).</p>
<h2 id="pre-enriched-data">Pre-enriched Data:<a href="#pre-enriched-data" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;snapshot&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_executable&#34;</span><span class="p">:</span> <span class="s2">&#34;Google Chrome&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_identifier&#34;</span><span class="p">:</span> <span class="s2">&#34;com.google.Chrome&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Chrome&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_short_version&#34;</span><span class="p">:</span> <span class="s2">&#34;134.0.6998.89&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_version&#34;</span><span class="p">:</span> <span class="s2">&#34;6998.89&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Google Chrome&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;last_opened_time&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-07-08 14:27:41&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Google Chrome.app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/Applications/Google Chrome.app&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_executable&#34;</span><span class="p">:</span> <span class="s2">&#34;Slack&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_identifier&#34;</span><span class="p">:</span> <span class="s2">&#34;com.tinyspeck.slackmacgap&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Slack&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_short_version&#34;</span><span class="p">:</span> <span class="s2">&#34;4.40.128&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_version&#34;</span><span class="p">:</span> <span class="s2">&#34;440000128&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Slack&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;last_opened_time&#34;</span><span class="p">:</span> <span class="s2">&#34;2025-03-12 16:12:21&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Slack.app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/Applications/Slack.app&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_executable&#34;</span><span class="p">:</span> <span class="s2">&#34;zoom.us&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_identifier&#34;</span><span class="p">:</span> <span class="s2">&#34;us.zoom.xos&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_name&#34;</span><span class="p">:</span> <span class="s2">&#34;zoom.us&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_short_version&#34;</span><span class="p">:</span> <span class="s2">&#34;5.16.10 (25689)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;bundle_version&#34;</span><span class="p">:</span> <span class="s2">&#34;5.16.10.25689&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;last_opened_time&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-02-07 17:30:20&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;zoom.us.app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/Applications/zoom.us.app&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="s2">&#34;snapshot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;pack/Global/App Usage&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;hostIdentifier&#34;</span><span class="p">:</span> <span class="s2">&#34;E0804EAC-481F-5BF3-AA00-8AA4EDE72395&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;calendarTime&#34;</span><span class="p">:</span> <span class="s2">&#34;Mon Mar 17 13:39:51 2025 UTC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unixTime&#34;</span><span class="p">:</span> <span class="mi">1742218791</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;epoch&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;counter&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;numerics&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;decorations&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;host_uuid&#34;</span><span class="p">:</span> <span class="s2">&#34;E0804EAC-481F-5BF3-AA00-8AA4EDE72395&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;hostname&#34;</span><span class="p">:</span> <span class="s2">&#34;macos-host&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>To enrich this JSON data structure so Loki can ingest it we need to use a Lambda transformation attached to the Kinesis Data Stream. When the Kinesis Data Stream receives incoming data it will buffer the events to the Lambda function which extracts the event records, decodes them from base64 and appends additional meta data that Loki can use.</p>
<h2 id="post-enriched-data">Post-enriched Data:<a href="#post-enriched-data" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;streams&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;stream&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;macos-host&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;host_uuid&#34;</span><span class="p">:</span> <span class="s2">&#34;E0804EAC-481F-5BF3-AA00-8AA4EDE72395&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_executable&#34;</span><span class="p">:</span> <span class="s2">&#34;Google Chrome&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_identifier&#34;</span><span class="p">:</span> <span class="s2">&#34;com.google.Chrome&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Chrome&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_version&#34;</span><span class="p">:</span> <span class="s2">&#34;6998.89&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/Applications/Google Chrome.app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;service_name&#34;</span><span class="p">:</span> <span class="s2">&#34;fleet-data-stream&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;values&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">              <span class="p">[</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;1742218797748051968&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;{\&#34;host\&#34;: \&#34;macos-host\&#34;, \&#34;host_uuid\&#34;: \&#34;E0804EAC-481F-5BF3-AA00-8AA4EDE72395\&#34;, \&#34;bundle_executable\&#34;: \&#34;Google Chrome\&#34;, \&#34;bundle_identifier\&#34;: \&#34;com.google.Chrome\&#34;, \&#34;bundle_name\&#34;: \&#34;Chrome\&#34;, \&#34;bundle_short_version\&#34;: \&#34;134.0.6998.89\&#34;, \&#34;bundle_version\&#34;: \&#34;6998.89\&#34;, \&#34;display_name\&#34;: \&#34;Google Chrome\&#34;, \&#34;name\&#34;: \&#34;Google Chrome.app\&#34;, \&#34;path\&#34;: \&#34;/Applications/Google Chrome.app\&#34;, \&#34;last_opened_time\&#34;: \&#34;2024-07-08 14:27:41\&#34;}&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">]</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;stream&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;macos-host&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;host_uuid&#34;</span><span class="p">:</span> <span class="s2">&#34;E0804EAC-481F-5BF3-AA00-8AA4EDE72395&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_executable&#34;</span><span class="p">:</span> <span class="s2">&#34;Slack&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_identifier&#34;</span><span class="p">:</span> <span class="s2">&#34;com.tinyspeck.slackmacgap&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Slack&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_version&#34;</span><span class="p">:</span> <span class="s2">&#34;440000128&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/Applications/Slack.app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;service_name&#34;</span><span class="p">:</span> <span class="s2">&#34;fleet-data-stream&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;values&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">              <span class="p">[</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;1742218797748051968&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;{\&#34;host\&#34;: \&#34;macos-host\&#34;, \&#34;host_uuid\&#34;: \&#34;E0804EAC-481F-5BF3-AA00-8AA4EDE72395\&#34;, \&#34;bundle_executable\&#34;: \&#34;Slack\&#34;, \&#34;bundle_identifier\&#34;: \&#34;com.tinyspeck.slackmacgap\&#34;, \&#34;bundle_name\&#34;: \&#34;Slack\&#34;, \&#34;bundle_short_version\&#34;: \&#34;4.40.128\&#34;, \&#34;bundle_version\&#34;: \&#34;440000128\&#34;, \&#34;display_name\&#34;: \&#34;Slack\&#34;, \&#34;name\&#34;: \&#34;Slack.app\&#34;, \&#34;path\&#34;: \&#34;/Applications/Slack.app\&#34;, \&#34;last_opened_time\&#34;: \&#34;2025-03-12 16:12:21\&#34;}&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">]</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;stream&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;macos-host&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;host_uuid&#34;</span><span class="p">:</span> <span class="s2">&#34;E0804EAC-481F-5BF3-AA00-8AA4EDE72395&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_executable&#34;</span><span class="p">:</span> <span class="s2">&#34;zoom.us&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_identifier&#34;</span><span class="p">:</span> <span class="s2">&#34;us.zoom.xos&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_name&#34;</span><span class="p">:</span> <span class="s2">&#34;zoom.us&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;bundle_version&#34;</span><span class="p">:</span> <span class="s2">&#34;5.16.10.25689&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/Applications/zoom.us.app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;service_name&#34;</span><span class="p">:</span> <span class="s2">&#34;fleet-data-stream&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;values&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">              <span class="p">[</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;1742218797748051968&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;{\&#34;host\&#34;: \&#34;macos-host\&#34;, \&#34;host_uuid\&#34;: \&#34;E0804EAC-481F-5BF3-AA00-8AA4EDE72395\&#34;, \&#34;bundle_executable\&#34;: \&#34;zoom.us\&#34;, \&#34;bundle_identifier\&#34;: \&#34;us.zoom.xos\&#34;, \&#34;bundle_name\&#34;: \&#34;zoom.us\&#34;, \&#34;bundle_short_version\&#34;: \&#34;5.16.10 (25689)\&#34;, \&#34;bundle_version\&#34;: \&#34;5.16.10.25689\&#34;, \&#34;display_name\&#34;: \&#34;\&#34;, \&#34;name\&#34;: \&#34;zoom.us.app\&#34;, \&#34;path\&#34;: \&#34;/Applications/zoom.us.app\&#34;, \&#34;last_opened_time\&#34;: \&#34;2024-02-07 17:30:20\&#34;}&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">]</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Loki requires data in this structured format because it follows the push-based JSON log entry model, where logs are grouped into streams identified by key-value pairs (labels) and contain timestamped values (log entries).</p>
<p>The <code>stream</code> object contains key-value pairs like <code>host</code>, <code>host_uuid</code>, and <code>bundle_identifier</code>, which act as labels in Loki. Labels allow efficient indexing and filtering when querying logs using Loki’s query language LogQL.</p>
<p>The <code>values</code> array holds log entries as a list of timestamp-value pairs. Each timestamp (<code>&quot;1742218797748051968&quot;</code>, which is in nanoseconds) ensures logs are stored in chronological order for accurate time-based queries.</p>
<p>This approach reduces storage overhead by indexing only labels, keeping log queries fast and efficient.</p>
<p>Using the Grafana Explore feature with this LogQL query we can extract specific application data:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">{<span class="l">bundle_identifier=&#34;us.zoom.xos&#34;,service_name=&#34;fleet-data-stream&#34;}</span><span class="w">
</span></span></span></code></pre></div><figure><img src="/posts/osquery-results-to-loki-with-kinesis-data-stream/loki-explore.webp"
    alt="Grafana explore results"><figcaption>
      <p>Grafana explore results</p>
    </figcaption>
</figure>

<p>The <code>Fields</code> meta data area describes the stream object labels we provided in the Lambda transformation and the timestamped data is a log event with nested values we could use to build time-based visualizations in LogQL.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">count(count_over_time({bundle_identifier=&#34;com.google.Chrome&#34;}[1d])) by (bundle_version)</span><span class="w">
</span></span></span></code></pre></div><figure><img src="/posts/osquery-results-to-loki-with-kinesis-data-stream/bundle-version-over-time.webp"
    alt="Results Over Time"><figcaption>
      <p>Results Over Time</p>
    </figcaption>
</figure>


      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
